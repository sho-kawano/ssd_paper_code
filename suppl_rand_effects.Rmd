---
title: "Additional Analysis on Random Effects"
author: "Sho Kawano"
date: "2024-12-26"
output: pdf_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message=F)
library(usmap)
library(tidyverse)
library(tidycensus)
library(patchwork)

source("samplers/ssd_fit.R")
```



```{r include=FALSE}
options(scipen=20)

# ---- Packages ---- 
library(bayesplot)
library(tidycensus)
library(spdep)
library(patchwork)
library(tidyverse)

# ---- Data ---- 
load("data/data_multi-state/data.RDA")

all_data <- all_data %>% 
  mutate(high_rentBurden = ifelse(rentBurden>0.4, T, F)) 

# the response 
covs = c("degree", "assistance", "no_car", "povPerc",  
         "white", "black", "native", "asian", "hispanic")
X <- model.matrix(~., all_data[, covs, drop=F]) 

y <- all_data$rentBurden
D <- all_data$rentBurdenSE^2
y.star <- log(y)
D.star <- D / y^2

center <- mean(y.star)
scale <- sd(y.star)
y.scaled <- (y.star-center)/scale
D.scaled <- D.star/scale^2

# ---- Load Chains ---- 
load("data_analysis_chains/bym_res2.RDA")
load("data_analysis_chains/dm_res2.RDA")
load("data_analysis_chains/fh_res2.RDA")
load("data_analysis_chains/new_res2.RDA")

# ---- Load Map -----
pop <- readRDS("data/sa_data_w_geom.RDS")
```



## SSD Model: Selection Probabilities vs Random Effects (S. Atlantic Census Division)


```{r include=FALSE}
# create the dataframe with the necessary data 
new_reffects = scale*(new_res$delta*(new_res$v1+new_res$v2)) %>% colMeans()

tmp.df = data.frame(area=1:nrow(all_data), 
                    sel_prob = new_res$p.delta %>% colMeans(),
                    reffects=new_reffects,
                    theta=exp(new_res$theta*scale+center) %>% colMeans() ) 
```

```{r fig.height=2.8, fig.width=5}
tmp.df %>% ggplot(aes(x=sel_prob, y=reffects)) + 
  geom_point(color="blue", alpha=0.5, shape=1) +
  ylab("Random Effects") +
  xlab("Selection Probabilities") +
  labs(caption="Comparing Posterior Means")
```


We can see that the areas where the selection probability is high (close to 1) also have larger magnitude random effects (both negative and positive). This makes sense given the posterior selection probability is

$$\hat p_i = \frac{p \cdot \phi \big(y_i | x_i^\top \boldsymbol{\beta} + v_{1i}+v_{2i}, \, d_i \big)}{p \cdot \phi \big(y_i | x_i^\top \boldsymbol{\beta} + v_{1i}+v_{2i}, \, d_i \big) + (1-p) \cdot \phi \big(y_i | x_i^\top \boldsymbol{\beta}, \, d_i \big)}$$

for area $i=1, \cdots, n$. Thus, if the random effect is large for area $i$, the difference between $\phi \big(y_i | x_i^\top \boldsymbol{\beta} + v_{1i}+v_{2i}, \, d_i \big)$ and  $\phi \big(y_i | x_i^\top \boldsymbol{\beta}, \, d_i \big)$ will be larger, impacting the selection probability. 



## Comparing Random Effects from Different Models 

### Scatterplot Comparisons  (Posterior Means) 

```{r fig.height=3, fig.width=7}
fh_reffects = fh_res$v %>% colMeans()
dm_reffects = (dm_res$v*dm_res$delta) %>% colMeans()
bym_reffects = (bym_res$v1+bym_res$v2) %>% colMeans()
new_reffects = scale*(new_res$delta*(new_res$v1+new_res$v2)) %>% colMeans()

tmp.df = data.frame(area=1:nrow(all_data), 
                    FH=fh_reffects, 
                    DM=dm_reffects, 
                    BYM=bym_reffects, 
                    New=new_reffects) %>% 
  pivot_longer(cols=DM:New, names_to="model", values_to = "reffects") %>% 
  mutate(model=ifelse(model=="New", "SSD", model))

tmp.df %>% ggplot(aes(x=FH, y=reffects)) + 
  geom_point(color="blue", alpha=0.5, shape=1) + 
  geom_abline(slope=1, alpha=0.7)+
  geom_hline(yintercept=0, alpha=0.2, lty=2)+
  geom_vline(xintercept=0, alpha=0.2, lty=2)+
  facet_wrap(~model) + 
  theme_bw()+
  xlab("Random Effects from Fay-Herriot") + 
  ylab("Random Effects from Others") 
```

We can see that the DM model most closely resembles the Fay-Herriot random effects, as they both assume independent and identically distributed (IID) random effects. The SSD model is somewhere between the BYM and the DM model, as expected. Of the models, SSD model allows for the biggest range in the random effect values. 




```{r }
tmp.df = data.frame(area=1:nrow(all_data),
                    FH=fh_reffects,
                    DM=dm_reffects,
                    BYM=bym_reffects,
                    New=new_reffects)

ref_table = data.frame(area=1:nrow(all_data), GEOID=all_data$fips)

plt_df = pop %>%
  left_join(ref_table) %>%
  left_join(tmp.df) %>%
    arrange(area)
plt_df = plt_df %>%
  pivot_longer(cols=FH:New, names_to="model", values_to = "reffects")
```



## Mapping Random Effects from the Different Models

```{r}
tmp.df = data.frame(area=1:nrow(all_data),
                    SSD=new_reffects,
                    FH=fh_reffects,
                    DM=dm_reffects,
                    BYM=bym_reffects
                    ) %>% 
    pivot_longer(cols=FH:BYM, names_to = "Model") %>% 
    mutate(Diff = value-SSD) 
  
pop %>%
  left_join(ref_table) %>%
  left_join(tmp.df)  %>% 
  ggplot(aes(fill = Diff )) +
  geom_sf() +
  scale_fill_distiller(palette = "BrBG") +
  labs(#title = "Random Effects Differences",
       fill = "Other-SSD", 
       caption="Comparing Posterior Means") +
  theme_void() +
  facet_wrap(~Model)
```

Here is a comparison of the differences between the SSD random effects and the other models. As expected, difference compared to the IID models (DM & FH) have a strong spatial pattern. The difference between the BYM and the SSD is marked by a few spots of large differences. It is interesting, however, that the difference in the random effects between these two models has still has a spatial pattern down by Florida. We can also see that compared to the non selection models (FH & BYM), there are a few counties where SSD random effects are much larger in magnitude.

In fact, we can see from the map below that the both models with selection (DM & SSD) has larger magnitude effects. This is due to these models not having a common variance assumption. This can be see in other places in the census division. 


```{r fig.dim=c(8, 7)}
plt_df %>%
  # filter(model %in% c("DM", "New")) %>% 
  mutate(model=ifelse(model=="New", "SSD", model)) %>% 
  mutate(model = factor(model, levels=c("FH", "DM", "BYM", "SSD"))) %>%
  ggplot(aes(fill = reffects )) +
  geom_sf() +
  # scale_fill_viridis_b(breaks=c(-0.15, -0.01, -0.005, 0.005, 0.01, 0.15)) +
  # scale_fill_distiller(palette = "BuPu") +
    scale_fill_distiller(palette = "PuOr", direction = 1) +
  labs(#title = "Random Effects from Each Model",
       caption="Comparing Posterior Means",
       fill = "Random Effects")  +
  theme_void() + facet_wrap(~model, nrow=2)
```

```{r}
set.seed(7)
test_fh=geary.mc(fh_reffects, mat2listw(A, style="W"), nsim=4000, zero.policy = F)
test_dm=geary.mc(dm_reffects, mat2listw(A, style="W"), nsim=4000, zero.policy = F)
```

Overall, we can see that all of the models have fairly similar spatial patterns.  A Monte-Carlo simulation of a Geary's C test was performed on the random effects for the non-spatial models (FH & DM). Here are the p-values: `r test_fh$p.value` and `r test_dm$p.value`.
