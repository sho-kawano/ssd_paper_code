---
title: "NC Simulation Study: MSE Analysis by Area"
author: "Sho Kawano | September 5, 2024"
output: pdf_document
---

```{r setup, include=F}
knitr::opts_chunk$set(echo = F, warning = F, message=F)
library(usmap)
library(tidyverse)
library(tidycensus)
library(patchwork)
```



```{r include=F}
load("data/data_NC/data.RDA")
load("sim_results_NC/results_by_sim.RDA")

pop <- readRDS("data/nc_data_w_geom.RDS")

tmp.df = errs_all_sims %>% 
  group_by(model, area) %>%
  reframe(mse=mean(err^2))

ref_table = data.frame(area=1:nrow(all_data), GEOID=all_data$fips)

tmp.df = tmp.df %>% pivot_wider(names_from = model, values_from = mse) %>%
  pivot_longer(cols=!c(D.Est, area), names_to = "model", values_to = "mse")

mse_pltDf = pop %>% left_join(ref_table, by = join_by(GEOID)) %>% 
  left_join(tmp.df, by = join_by(area)) %>% 
  filter(model!="CAR") %>% 
  mutate(model=ifelse(model=="New", "SSD", model))
```

## MSE from Direct Estimates vs. Models by Area

```{r fig.width=7, fig.height=5}
mse_pltDf %>% 
  ggplot(aes(x=log(D.Est), y=log(mse) )) +  
  facet_wrap(~model, nrow=2) +
  geom_abline(slope=1) + 
  geom_tile(aes(x=-6, y=-5, width=2, height=2), fill=NA, color="blue")+
  geom_point(alpha=0.5) +
  coord_fixed() +
  xlab("log(MSE) for D.Est") + 
  ylab("log(MSE) for Models") + 
  ggtitle("") +
  theme(axis.text.x = element_text(angle = 45))
```

Note that the points shown are *averages by area for the 300 simulations*. If a model outperformed the direct estimate for a given area, a point would lie *below* the line. We can see that the SSD model achieves a MSE reductions across the board. 


```{r}
df1 = errs_all_sims %>% 
  group_by(model, area) %>% 
  reframe(mse=mean(err^2)) %>% 
  pivot_wider(names_from = model, values_from = mse) %>%
  mutate(BYM=D.Est-BYM,
       DM=D.Est-DM,
       FH=D.Est-FH,
       New=D.Est-New) %>%
  select(-D.Est) %>% 
  pivot_longer(cols=!area, names_to = "model", values_to = "mse")

df3 = df1 %>% 
  pivot_wider(names_from = model, values_from = mse) %>%
  pivot_longer(cols=!area, names_to = "model", values_to = "mse") %>% 
  group_by(area, model) %>% 
  reframe( mse_reduction=mse) 

mse_pltDf = pop %>% left_join(ref_table, by = join_by(GEOID)) %>% 
  left_join(df3, by = join_by(area)) %>% 
  filter(model!="CAR") 
```



```{r}
# show MSE table 
mse_pltDf %>% 
  as.data.frame() %>% 
  select(GEOID, NAME, area, model, mse_reduction) %>% 
  mutate(model=ifelse(model=="New", "SSD", model)) %>% 
  group_by(model) %>% 
  summarise(Min=min(mse_reduction), 
            Q1=quantile(mse_reduction, 0.25), 
            Mean=mean(mse_reduction),
            Median=median(mse_reduction), 
            Q3=quantile(mse_reduction, 0.75), 
            Max=max(mse_reduction)
            ) %>% 
  arrange(desc(Mean)) %>% knitr::kable()
```

There are a few areas where using a model increases MSE (enclosed in rectangle) relative to the direct estimate. The increase in MSE is *lower* for SSD model than all other models. This is a major factor in why the SSD model outperforms others. This can also be seen from the summary statistics of the MSE **reduction** relative to the direct estimate (on original scale) shown above: $MSE - MSE_{D.Est}$.


```{r include=F}
# re-computing everything RELATIVE to the SSD model 

load("data/data_NC/data.RDA")
load("sim_results_NC/results_by_sim.RDA")

pop <- readRDS("data/nc_data_w_geom.RDS")

tmp.df = errs_all_sims %>%
  group_by(model, area) %>%
  reframe(mse=mean(err^2))

ref_table = data.frame(area=1:nrow(all_data), GEOID=all_data$fips)

tmp.df = tmp.df %>% pivot_wider(names_from = model, values_from = mse) %>%
  pivot_longer(cols=!c(New, area), names_to = "model", values_to = "mse") %>%
  rename(SSD=New)

df3 <- tmp.df %>% mutate(mse_diff=mse-SSD) %>% 
  select(-SSD, -mse) %>% 
  pivot_wider(names_from = model, values_from = mse_diff) %>% 
  pivot_longer(cols=!area, names_to = "model", values_to = "mse_reduction")

mse_pltDf = pop %>%
  left_join(ref_table, by = join_by(GEOID)) %>%
  left_join(df3, by = join_by(area))
```





## Spatial Distribution of MSE Decreases/Increases Relative to SSD Model 


```{r message=FALSE, fig.height=2.5, fig.width=8}
library(latex2exp)
tmp.df = data.frame(area=1:nrow(all_data),
                    SE = all_data$rentBurdenSE) 

ref_table = data.frame(area=1:nrow(all_data), GEOID=all_data$fips)

plt_df = pop %>%
  left_join(ref_table, by = join_by(GEOID)) %>%
  left_join(tmp.df, by = join_by(area)) %>%
    arrange(area)

plt_df = plt_df %>%
  pivot_longer(cols=SE, names_to="model", values_to = "d_i")


plt2 = plt_df %>%
  # mutate(model = factor(model, levels=c("FH", "DM", "BYM", "New"))) %>%
  filter(model!="Diff") %>% 
  ggplot(aes(fill = log(d_i))) +
  geom_sf() +
  # scale_fill_viridis_b(direction=-1) +
  scale_fill_distiller(palette = "PiYG") +
  labs(title = TeX("Log Design SE"),
       fill = TeX("$log(\\sqrt{d_i})$"))  +
  theme_void(base_size = 11)  +
  theme(plot.title = element_text(size = rel(0.8)),
        legend.position = "left",
              legend.title = element_text(size = 8), 
              legend.text  = element_text(size = 8),
              legend.key.width =  unit(0.6, "lines"))


tmp.df = data.frame(area=1:nrow(all_data),
                    D.Est = all_data$rentBurden) 

ref_table = data.frame(area=1:nrow(all_data), GEOID=all_data$fips)

plt_df = pop %>%
  left_join(ref_table) %>%
  left_join(tmp.df) %>%
    arrange(area)

plt_df = plt_df %>%
  pivot_longer(cols=D.Est, names_to="model", values_to = "theta")


plt1 = plt_df %>%
  # mutate(model = factor(model, levels=c("FH", "DM", "BYM", "New"))) %>%
  filter(model!="Diff") %>% 
  ggplot(aes(fill = theta)) +
  geom_sf() +
  # scale_fill_viridis_b(direction=-1) +
  scale_fill_distiller(palette = "RdYlBu") +
  labs(title = TeX("'True' Small Area Means"),
       fill = TeX("$z_i$"))  +
  theme_void(base_size = 11) + 
  theme(plot.title = element_text(size = rel(0.8)),
        legend.position = "left",
              legend.title = element_text(size = 8), 
              legend.text  = element_text(size = 8),
              legend.key.width =  unit(0.6, "lines"))

plt1 + plt2
```





First is a map of the `true' small area means in this simulation study and the log design SEs. We can see that some counties along the western edge and northeastern corners of the state have the highest/lowest values as well as high design SE's.  Intuitively, the top 5 counties in terms of MSE reductions (relative to the SSD model) are mostly located in these places. 

```{r fig.width=8, fig.height=5}
df4 = df3 %>% group_by(model) %>% 
  mutate(rank=rank(mse_reduction)) %>% 
  mutate(rank=ifelse(rank>=95, "Top 5", NA))
  

mse_pltDf = pop %>% left_join(ref_table, by = join_by(GEOID)) %>% 
  left_join(df4, by = join_by(area))

mse_pltDf %>% 
  ggplot(aes(fill = rank)) +
  geom_sf() +
  theme_void() + facet_wrap(~model, nrow=2) +
  labs(title = "Locations of Top 5 MSE Reduction Counties",
       caption= "Compared to SSD Model", 
       fill="") 
```

### Where did SSD Model decreae MSE?

We can see the spatial distribution of MSE *reduction* relative to SSD Model below. The *lighter* the color, the higher the MSE reduction is and vice versa. 

Note on log MSE reductions:

- $-3$ log MSE reduction is approximately $\approx 0.223^2$ on the original scale 
- $-6$ log MSE reduction is approximately $\approx 0.05^2$ on the original scale 
- $-9$ log MSE reduction is approximately $\approx 0.01^2$ on the original scale 
- $-12$ log MSE reduction is approximately $\approx 0.0025^2$ on the original scale 

```{r fig.width=8, fig.height=5}
mse_pltDf %>% 
  mutate(mse_reduction = ifelse(mse_reduction > 0, mse_reduction, 0)) %>% 
  ggplot(aes(fill = log(mse_reduction))) +
  geom_sf() +
  scale_fill_viridis_c(direction=+1, option="G") +
  labs(title = "MSE Reduction Relative to SSD Model",
       fill = "log(MSE *reduction*)") +
  theme_void() + facet_wrap(~model, nrow=2)
```

We can see that the highest MSE reductions by the SSD are achieved in the northeastern corner of the state. These are the same counties where the models generally struggle with compared to the direct estimate. This echoes what we saw in the first plot. Outside of the high reduction counties, the patterns differ a bit but there are still some similarities. 



<!-- ### Where did SSD Model increase MSE? -->

<!-- Below are the summary statistics for the square root of the MSE increases.  -->

<!-- We can also see where MSE *increased* relative to the SSD Model. We can see that the SSD model seems to increase MSE slightly compared to the models in many areas (which is compensated by large reductions in a few areas). Note that $-10$ log MSE reduction is approximately $\approx 0.007^2$ on the original scale  -->


<!-- ```{r fig.width=8, fig.height=5} -->
<!-- mse_pltDf %>%  -->
<!--   mutate(mse_increase = ifelse(mse_reduction < 0, -mse_reduction, 0)) %>%  -->
<!--   ggplot(aes(fill = log(mse_increase) )) + -->
<!--   geom_sf() + -->
<!--   scale_fill_viridis_c(option="G") + -->
<!--   labs(title = "MSE Increase Relative to SSD Model", -->
<!--        fill = "log(MSE *increase*)")  + -->
<!--   theme_void() + facet_wrap(~model, nrow=2)  -->
<!-- ``` -->



## Coverage Analysis

### Undercoverage of a 90% credible interval by model 


```{r}
# Calculating coverage by area 
covRate_df <- ci_all_sims %>% group_by(area, model) %>%
   reframe(cov_rate=mean(covered)) 

cr_pltDf = pop %>% 
  left_join(ref_table, by = join_by(GEOID)) %>% 
  left_join(covRate_df, by = join_by(area)) %>% 
  filter(model!="CAR") %>% 
  mutate(model=ifelse(model=="New", "SSD", model))
```

```{r fig.width=8, fig.height=4}
cr_pltDf %>% 
  ggplot(aes(fill = 0.9-cov_rate)) +
  geom_sf() +
  theme_void() + facet_wrap(~model, nrow=2) +
  scale_fill_viridis_c(option="magma") + 
    labs(title = "",
       fill = "0.9-Cov.Rate") 
```

Here we plot the undercoverage of the average coverage rate in each area. We define undercoverage as $0.9-\textrm{Avg. Coverage Rate}$. If a model, on average achives 90% coverage in a given area, the value should be zero.

We can see from this plot that undercoverage is very high in the same counties (located in the northeastern and western edges of the state) that had accuracy issues. The models without random effects selection (BYM and FH models) struggle mightily in these areas. The DM model struggles a bit less than the other models in these areas but has higher undercoverage in other parts of the state. This can also be seen in the plot below. 


### Log Design SEs vs. Coverage by model

```{r fig.width=7, fig.height=4}
tmp.df = data.frame(area=1:nrow(all_data),
                    SE = all_data$rentBurdenSE) 

covRate_df %>% left_join(tmp.df) %>% 
  filter(model!="CAR") %>% 
  mutate(model=ifelse(model=="New", "SSD", model)) %>% 
  ggplot(aes(x=log(SE), y=cov_rate)) + 
  geom_point(alpha=0.7) + 
  facet_wrap(~model, nrow=2) +
  geom_hline(yintercept = 0.9, lty=2, color="blue") +
  theme_bw() +
  geom_area(aes(y=0.7), fill="red", alpha=0.1) +
      labs(title = "", 
           caption="Coverage of a 90% Credible Interval") +
  ylab("Coverage Rate")
```

Here is a plot of the log design SEs compared to the coverage rate of a 90% credible interval from each model. The dotted line is 90% (the target coverage rate), and the red area indicates coverage below 70%. We can see that the coverage rate for many models start to drop as the SE gets larger. There is a clear difference when you compare the SSD to the other models. 

Below is a table with the minimum, 5th, 10th, and 25th percentile values of the coverage rate (rounded to the 4th digit). In fact, we can see that the BYM and the FH have horrible coverage for the lowest 5% of counties but has better coverage for the 25th percentile than the DM. This is what results in the DM having very low coverage overall. Again, the SSD really outperforms the other models. 

```{r}
covRate_df %>% group_by(model) %>% 
   filter(model!="CAR") %>%
  mutate(model=ifelse(model=="New", "SSD", model)) %>% 
  reframe(Min=min(cov_rate), 
          `5th Percentile`=quantile(cov_rate, 0.05) %>% round(4), 
          `10th Percentile`=quantile(cov_rate, 0.1) %>% round(4), 
          `25th Perentile`=quantile(cov_rate, 0.25) %>% round(4), 
          Mean = mean(cov_rate) %>% round(4)) %>% 
  knitr::kable()
```



## Summary

### MSE 

- There are areas in the eastern parts of the state where models struggle in terms of accuracy where design SE is large. The SSD performs the best in these areas compared to the other models. 
- Reductions over the direct estimate are achieved in most counties
- Reductions over the other model estimates are concentrated in a few counties where high and small area means are adjacent to each other. This is seen in the northeastern/eastern part of the state and some counties along the western edge of the state. 

### Coverage

- The same areas that have accuracy issues also cause coverage issues for the other models 
- BYM and the FH have horrible coverage for the lowest 5% of counties (compared to the DM & SSD) but has better coverage for the 25th percentile than the DM. 



